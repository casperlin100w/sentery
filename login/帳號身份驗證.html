<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Sentry AI å¸³è™Ÿèº«ä»½é©—è­‰æ“ä½œå¥—ä»¶</title>
    <!-- å¼•å…¥ Tailwind CSS CDN ä»¥é€²è¡Œç¾åŒ– -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-button.active {
            border-color: #4f46e5; /* indigo-600 */
            color: #4f46e5;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-start justify-center p-4 sm:p-8">

    <!-- ä¸»å®¹å™¨ -->
    <div class="w-full max-w-2xl bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">The Sentry AI å¸³è™Ÿèº«ä»½é©—è­‰æ“ä½œå¥—ä»¶</h1>
        
        <!-- è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
        <div id="message" class="mb-4 p-3 rounded-lg text-center font-medium hidden"></div>

        <!-- ç™»å…¥ç‹€æ…‹é¡¯ç¤º -->
        <div id="auth-status" class="flex justify-between items-center bg-indigo-50 p-4 rounded-lg mb-6 border border-indigo-200">
            <span id="current-user-email" class="text-indigo-800 font-semibold truncate">æœªç™»å…¥</span>
            <button id="logout-button" onclick="window.handleLogout()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-sm shadow-md transition hidden">ç™»å‡º</button>
        </div>

        <!-- ä¸»è¦æ“ä½œå€åŸŸ -->
        <div id="main-content">
            <!-- å°èˆªæ¨™ç±¤ -->
            <div class="flex border-b border-gray-200 mb-6">
                <button class="tab-button active" data-view="login">ç™»å…¥</button>
                <button class="tab-button" data-view="register">è¨»å†Š</button>
                <button class="tab-button" data-view="reset">é‡è¨­å¯†ç¢¼</button>
                <button class="tab-button" data-view="management">å¸³è™Ÿç®¡ç†</button>
            </div>

            <!-- ç™»å…¥è¦–åœ– -->
            <div id="login-view" class="view">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">ç™»å…¥</h2>
                <input type="email" id="login-email" placeholder="é›»å­éƒµä»¶" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <input type="password" id="login-password" placeholder="å¯†ç¢¼" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="window.handleLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150">ç™»å…¥</button>
            </div>

            <!-- è¨»å†Šè¦–åœ– -->
            <div id="register-view" class="view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">è¨»å†Šæ–°å¸³è™Ÿ</h2>
                <input type="email" id="signup-email" placeholder="é›»å­éƒµä»¶" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <input type="password" id="signup-password" placeholder="å¯†ç¢¼ (è‡³å°‘ 6 ä½)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="window.handleSignUp()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150">è¨»å†Šä¸¦ç™¼é€é©—è­‰éƒµä»¶</button>
            </div>

            <!-- é‡è¨­å¯†ç¢¼è¦–åœ– -->
            <div id="reset-view" class="view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">é‡è¨­å¯†ç¢¼</h2>
                <p class="mb-4 text-gray-600">è¼¸å…¥æ‚¨çš„é›»å­éƒµä»¶åœ°å€ï¼Œæˆ‘å€‘æœƒç™¼é€ä¸€å€‹å¯†ç¢¼é‡è¨­é€£çµã€‚</p>
                <input type="email" id="reset-email" placeholder="é›»å­éƒµä»¶" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="window.handlePasswordReset()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150">ç™¼é€é‡è¨­éƒµä»¶</button>
            </div>

            <!-- å¸³è™Ÿç®¡ç†è¦–åœ– -->
            <div id="management-view" class="view hidden">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">å¸³è™Ÿç®¡ç†</h2>

                <!-- é©—è­‰ç‹€æ…‹ -->
                <p class="text-lg font-medium mb-3">é›»å­éƒµä»¶é©—è­‰ç‹€æ…‹: <span id="verification-status" class="font-bold text-red-500">æœªè¼‰å…¥</span></p>

                <!-- é‡ç™¼é©—è­‰éƒµä»¶ -->
                <button onclick="window.handleSendVerification()" id="verify-button" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150 mb-4">é‡ç™¼é©—è­‰éƒµä»¶</button>

                <!-- åˆªé™¤å¸³è™Ÿå€å¡Š -->
                <div id="delete-account-section" class="mt-8 p-4 bg-red-100 border border-red-300 rounded-lg">
                    <h3 class="text-xl font-bold text-red-800 mb-3">åˆªé™¤å¸³è™Ÿ</h3>
                    <p class="text-red-700 mb-4">ç‚ºäº†å®‰å…¨èµ·è¦‹ï¼Œæ‚¨éœ€è¦é‡æ–°è¼¸å…¥å¯†ç¢¼ä¾†ç¢ºèªæ‚¨çš„èº«ä»½ï¼Œæ‰èƒ½åˆªé™¤æ­¤å¸³è™Ÿã€‚</p>
                    
                    <div id="reauth-section">
                        <input type="password" id="reauth-password" placeholder="é‡æ–°è¼¸å…¥æ‚¨çš„å¯†ç¢¼" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        <button onclick="window.handleReauthenticate()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-150">ç¢ºèªèº«ä»½</button>
                    </div>

                    <button onclick="window.deleteAccountFinal()" id="final-delete-button" class="w-full bg-gray-400 text-white font-bold py-3 rounded-lg mt-4 cursor-not-allowed" disabled>
                        æ°¸ä¹…åˆªé™¤å¸³è™Ÿ (è«‹å…ˆé©—è­‰)
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- èº«ä»½é©—è­‰èˆ‡ Firestore é‚è¼¯ (å·²åˆä½µ firebase-config.js å…§å®¹) -->
    <script type="module">
        // -------------------------------------------------------------
        // 1. å°å…¥æ¨¡çµ„èˆ‡æœå‹™åˆå§‹åŒ–
        // -------------------------------------------------------------

        // å°å…¥ Firebase æ ¸å¿ƒåŠŸèƒ½
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        // å°å…¥ Auth å’Œ Firestore æ¨¡çµ„
        import { getAuth, 
                 createUserWithEmailAndPassword, 
                 sendEmailVerification, 
                 sendPasswordResetEmail,
                 signInWithEmailAndPassword,
                 signOut,
                 onAuthStateChanged,
                 deleteUser, 
                 EmailAuthProvider, 
                 reauthenticateWithCredential 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // *** åŸ firebase-config.js çš„å…§å®¹å·²åˆä½µåˆ°æ­¤è™• ***
        // æ‚¨çš„ Web App Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCtbjdi-x3E3eNgX8WvBtgibOTRG4idny4",
            authDomain: "workai-1d692.firebaseapp.com",
            projectId: "workai-1d692",
            storageBucket: "workai-1d692.firebasestorage.app",
            messagingSenderId: "156453625217",
            appId: "1:156453625217:web:f04e2da964ddb6d449dc80",
            measurementId: "G-71NV0L4CGS"
        };
        
        // åˆå§‹åŒ– Firebase App
        const app = initializeApp(firebaseConfig);
        // *** -------------------------------------------- ***

        // æœå‹™å¯¦ä¾‹
        const auth = getAuth(app);
        const db = getFirestore(app); 

        // å…¨å±€ç‹€æ…‹
        let isUserReauthenticated = false;
        
        // å…ƒç´ ç²å–
        const messageDiv = document.getElementById('message');
        const reauthSection = document.getElementById('reauth-section');
        const finalDeleteButton = document.getElementById('final-delete-button');
        const currentUserEmailSpan = document.getElementById('current-user-email');
        const logoutButton = document.getElementById('logout-button');
        const verificationStatusSpan = document.getElementById('verification-status');
        const verifyButton = document.getElementById('verify-button');


        // -------------------------------------------------------------
        // 2. è¼”åŠ©å‡½å¼ (é¡¯ç¤º/åˆ‡æ›è¦–åœ–/è¨Šæ¯)
        // -------------------------------------------------------------

        /**
         * é¡¯ç¤ºè¨Šæ¯
         * @param {string} msg è¨Šæ¯å…§å®¹
         * @param {string} type è¨Šæ¯é¡å‹ ('success', 'error', 'info')
         */
        function showMessage(msg, type = 'info') {
            messageDiv.textContent = msg;
            messageDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-blue-100', 'text-green-800', 'text-red-800', 'text-blue-800');
            
            if (type === 'success') {
                messageDiv.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageDiv.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageDiv.classList.add('bg-blue-100', 'text-blue-800');
            }
        }

        /**
         * åˆ‡æ›è¦–åœ–
         * @param {string} viewId è¦é¡¯ç¤ºçš„è¦–åœ– ID (ä¸å« -view)
         */
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`${viewId}-view`).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('data-view') === viewId) {
                    button.classList.add('active');
                }
            });
            // æ¯æ¬¡åˆ‡æ›ï¼Œé‡ç½®é‡æ–°é©—è­‰ç‹€æ…‹
            if (viewId !== 'management') {
                isUserReauthenticated = false;
                updateDeleteView(auth.currentUser);
            }
        }
        
        // è¨­ç½®æ¨™ç±¤é»æ“Šäº‹ä»¶
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                showView(button.getAttribute('data-view'));
            });
        });

        // -------------------------------------------------------------
        // 3. æ¬Šé™ç›¸é—œå‡½å¼ (æ–°å¢)
        // -------------------------------------------------------------

        /**
         * å¾ Firestore è®€å–ç•¶å‰ç”¨æˆ¶çš„è§’è‰²
         * @param {Object} user Firebase User Object
         * @returns {string | null} è§’è‰²å­—ä¸² ('user', 'tech') æˆ– null
         */
        const getUserRole = async (user) => {
            if (!user) return null;

            try {
                // è®€å– /users/{uid} æ–‡ä»¶
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    // è¿”å› 'role' æ¬„ä½çš„å€¼ï¼Œè‹¥ä¸å­˜åœ¨å‰‡é è¨­ç‚º 'user'
                    return userSnap.data().role || 'user'; 
                } else {
                    console.warn("Firestore æ‰¾ä¸åˆ°ç”¨æˆ¶æ–‡ä»¶:", user.uid);
                    // ç‚ºäº†å®‰å…¨ï¼Œå¦‚æœæ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œè¦–ç‚ºæ™®é€šç”¨æˆ¶
                    return 'user'; 
                }
            } catch (error) {
                console.error("è®€å–ç”¨æˆ¶è§’è‰²å¤±æ•—:", error);
                return 'user'; // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œä¹Ÿé è¨­ç‚ºæ™®é€šç”¨æˆ¶
            }
        };


        // -------------------------------------------------------------
        // 4. èº«ä»½é©—è­‰æ“ä½œ
        // -------------------------------------------------------------

        /** * è™•ç†ç™»å…¥ 
         */
        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showMessage('é›»å­éƒµä»¶å’Œå¯†ç¢¼ä¸èƒ½ç‚ºç©ºã€‚', 'error');
                return;
            }

            showMessage('æ­£åœ¨å˜—è©¦ç™»å…¥...', 'info');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                if (!user.emailVerified) {
                    await signOut(auth); // æœªé©—è­‰ï¼Œå…ˆç™»å‡º
                    showMessage('âŒ ç™»å…¥å¤±æ•—ï¼è«‹å…ˆæª¢æŸ¥æ‚¨çš„é›»å­éƒµä»¶ä¸¦å®Œæˆé©—è­‰ã€‚', 'error');
                    return;
                }

                // *** å‘¼å«è§’è‰²æª¢æŸ¥å‡½å¼ ***
                const role = await getUserRole(user);

                if (role === 'tech') {
                    showMessage(`âœ… ç™»å…¥æˆåŠŸï¼(æŠ€è¡“äººå“¡æ¬Šé™) æ­¡è¿ ${user.email}ï¼`, 'success');
                } else {
                    showMessage(`âœ… ç™»å…¥æˆåŠŸï¼(æ™®é€šç”¨æˆ¶æ¬Šé™) æ­¡è¿ ${user.email}ï¼`, 'success');
                }
                
                showView('management'); // ç™»å…¥æˆåŠŸå¾Œè·³è½‰åˆ°ç®¡ç†é é¢

            } catch (error) {
                let displayMessage = 'ç™»å…¥å¤±æ•—ã€‚';
                switch(error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        displayMessage = 'é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚';
                        break;
                    case 'auth/too-many-requests':
                        displayMessage = 'å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                        break;
                    default:
                        console.error("ç™»å…¥éŒ¯èª¤:", error);
                }
                showMessage(`âŒ ${displayMessage}`, 'error');
            }
        };

        /**
         * è™•ç†è¨»å†Š 
         */
        window.handleSignUp = async () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            if (!email || !password || password.length < 6) {
                showMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶å’Œè‡³å°‘ 6 ä½çš„å¯†ç¢¼ã€‚', 'error');
                return;
            }

            showMessage('æ­£åœ¨å˜—è©¦è¨»å†Šä¸¦ç™¼é€é©—è­‰éƒµä»¶...', 'info');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // ç™¼é€é©—è­‰éƒµä»¶
                await sendEmailVerification(user);
                
                // è¨»å†ŠæˆåŠŸå¾Œè‡ªå‹•ç™»å‡ºï¼Œä»¥ä¾¿ç”¨æˆ¶é€šéé©—è­‰éƒµä»¶ç™»å…¥
                await signOut(auth);

                showMessage(`âœ… è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ ${email} çš„æ”¶ä»¶ç®±ä¸¦é»æ“Šé©—è­‰é€£çµã€‚`, 'success');
                showView('login');

            } catch (error) {
                let displayMessage = 'è¨»å†Šå¤±æ•—ã€‚';
                if (error.code === 'auth/email-already-in-use') {
                    displayMessage = 'è©²é›»å­éƒµä»¶å·²è¢«è¨»å†Šã€‚è«‹ç›´æ¥ç™»å…¥æˆ–é‡è¨­å¯†ç¢¼ã€‚';
                } else if (error.code === 'auth/weak-password') {
                    displayMessage = 'å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹ä½¿ç”¨æ›´è¤‡é›œçš„å¯†ç¢¼ã€‚';
                } else {
                    console.error("è¨»å†ŠéŒ¯èª¤:", error);
                }
                showMessage(`âŒ ${displayMessage}`, 'error');
            }
        };

        /**
         * è™•ç†ç™»å‡º 
         */
        window.handleLogout = async () => {
            showMessage('æ­£åœ¨ç™»å‡º...', 'info');
            try {
                await signOut(auth);
                showMessage('ğŸ‘‹ å·²ç™»å‡ºã€‚', 'info');
            } catch (error) {
                console.error("ç™»å‡ºéŒ¯èª¤:", error);
                showMessage('âŒ ç™»å‡ºå¤±æ•—ã€‚', 'error');
            }
        };

        /**
         * è™•ç†é‡è¨­å¯†ç¢¼éƒµä»¶
         */
        window.handlePasswordReset = async () => {
            const email = document.getElementById('reset-email').value;
            if (!email) {
                showMessage('è«‹è¼¸å…¥æ‚¨çš„é›»å­éƒµä»¶åœ°å€ã€‚', 'error');
                return;
            }

            showMessage('æ­£åœ¨ç™¼é€å¯†ç¢¼é‡è¨­éƒµä»¶...', 'info');

            try {
                await sendPasswordResetEmail(auth, email);
                showMessage(`âœ… å¯†ç¢¼é‡è¨­éƒµä»¶å·²ç™¼é€åˆ° ${email}ã€‚`, 'success');
                showView('login');
            } catch (error) {
                let displayMessage = 'ç™¼é€å¤±æ•—ã€‚è«‹æª¢æŸ¥é›»å­éƒµä»¶æ˜¯å¦æœ‰æ•ˆã€‚';
                if (error.code === 'auth/user-not-found') {
                    displayMessage = 'æ‰¾ä¸åˆ°æ­¤é›»å­éƒµä»¶çš„ç”¨æˆ¶ã€‚';
                }
                showMessage(`âŒ ${displayMessage}`, 'error');
            }
        };

        /**
         * è™•ç†ç™¼é€é©—è­‰éƒµä»¶
         */
        window.handleSendVerification = async () => {
            const user = auth.currentUser;
            if (!user) {
                showMessage('æ²’æœ‰ç”¨æˆ¶ç™»å…¥ï¼Œç„¡æ³•ç™¼é€é©—è­‰éƒµä»¶ã€‚', 'error');
                return;
            }
            if (user.emailVerified) {
                showMessage('é›»å­éƒµä»¶å·²ç¶“é©—è­‰éäº†ã€‚', 'info');
                return;
            }

            showMessage('æ­£åœ¨é‡æ–°ç™¼é€é©—è­‰éƒµä»¶...', 'info');
            try {
                await sendEmailVerification(user);
                showMessage('âœ… é©—è­‰éƒµä»¶å·²é‡æ–°ç™¼é€ï¼Œè«‹æª¢æŸ¥æ‚¨çš„æ”¶ä»¶ç®±ã€‚', 'success');
            } catch (error) {
                console.error("ç™¼é€é©—è­‰éƒµä»¶éŒ¯èª¤:", error);
                showMessage('âŒ ç™¼é€é©—è­‰éƒµä»¶å¤±æ•—ã€‚', 'error');
            }
        };


        // -------------------------------------------------------------
        // 5. åˆªé™¤å¸³è™Ÿæ“ä½œ
        // -------------------------------------------------------------

        /**
         * è™•ç†èº«ä»½é‡æ–°é©—è­‰
         */
        window.handleReauthenticate = async () => {
            const user = auth.currentUser;
            const password = document.getElementById('reauth-password').value;

            if (!user || !password) {
                showMessage('è«‹è¼¸å…¥å¯†ç¢¼ã€‚', 'error');
                return;
            }

            showMessage('æ­£åœ¨é‡æ–°é©—è­‰èº«ä»½...', 'info');

            try {
                const credential = EmailAuthProvider.credential(user.email, password);
                await reauthenticateWithCredential(user, credential);
                
                isUserReauthenticated = true;
                showMessage('âœ… èº«ä»½é©—è­‰æˆåŠŸï¼æ‚¨ç¾åœ¨å¯ä»¥åˆªé™¤å¸³è™Ÿäº†ã€‚', 'success');
                updateDeleteView(user);

            } catch (error) {
                isUserReauthenticated = false;
                showMessage('âŒ èº«ä»½é©—è­‰å¤±æ•—ï¼šå¯†ç¢¼éŒ¯èª¤æˆ–æ“ä½œé€¾æ™‚ã€‚', 'error');
                updateDeleteView(user);
                console.error("é‡æ–°é©—è­‰éŒ¯èª¤:", error);
            }
        };

        /**
         * æ›´æ–°åˆªé™¤å¸³è™Ÿè¦–åœ–çš„ç‹€æ…‹
         */
        function updateDeleteView(user) {
            if (!user) {
                finalDeleteButton.disabled = true;
                finalDeleteButton.textContent = 'æ°¸ä¹…åˆªé™¤å¸³è™Ÿ (è«‹å…ˆç™»å…¥)';
                finalDeleteButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                finalDeleteButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                reauthSection.classList.remove('hidden');
                return;
            }

            if (isUserReauthenticated) {
                reauthSection.classList.add('hidden');
                finalDeleteButton.disabled = false;
                finalDeleteButton.textContent = 'â— æ°¸ä¹…åˆªé™¤æ­¤å¸³è™Ÿ';
                finalDeleteButton.classList.add('bg-red-600', 'hover:bg-red-700');
                finalDeleteButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            } else {
                reauthSection.classList.remove('hidden');
                finalDeleteButton.disabled = true;
                finalDeleteButton.textContent = 'æ°¸ä¹…åˆªé™¤å¸³è™Ÿ (è«‹å…ˆé©—è­‰)';
                finalDeleteButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                finalDeleteButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        /**
         * æœ€çµ‚åˆªé™¤å¸³è™Ÿ
         */
        window.deleteAccountFinal = async () => {
            if (!isUserReauthenticated) {
                showMessage('è«‹å…ˆå®Œæˆèº«ä»½é‡æ–°é©—è­‰ï¼', 'error');
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                showMessage('æ²’æœ‰ç”¨æˆ¶ç™»å…¥ï¼Œç„¡æ³•åˆªé™¤ã€‚', 'error');
                return;
            }

            // æ¨¡æ“¬ confirmï¼šä½¿ç”¨ window.prompt é¿å… iFrame è¡çª
            const confirmation = window.prompt("æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å¸³è™Ÿå—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†è½‰ï¼\n\nè«‹è¼¸å…¥ 'YES' ç¢ºèªåˆªé™¤ã€‚") === 'YES';
            if (!confirmation) {
                showMessage('å·²å–æ¶ˆåˆªé™¤ã€‚', 'info');
                return;
            }

            showMessage('æ­£åœ¨æ°¸ä¹…åˆªé™¤å¸³è™Ÿ...', 'info');

            try {
                await deleteUser(user);
                
                showMessage('ğŸ‰ å¸³è™Ÿå·²æˆåŠŸåˆªé™¤ï¼æ‚¨å·²ç™»å‡ºã€‚', 'success');
                // åˆªé™¤æˆåŠŸå¾Œï¼ŒonAuthStateChanged æœƒè‡ªå‹•æ›´æ–°ç‹€æ…‹
                showView('login');

            } catch (error) {
                let displayMessage;
                if (error.code === 'auth/requires-recent-login') {
                    displayMessage = 'â— å®‰å…¨é™åˆ¶ï¼šæ“ä½œé€¾æ™‚ã€‚è«‹é‡æ–°ç™»å…¥ï¼ˆåˆ‡æ›åˆ°ç™»å…¥é é¢å¾Œå†ç™»å…¥ï¼‰ä¸¦ç«‹å³å†æ¬¡å˜—è©¦åˆªé™¤ã€‚';
                    // é‡æ–°è¦æ±‚é©—è­‰
                    isUserReauthenticated = false;
                    updateDeleteView(user);
                } else {
                    displayMessage = `âŒ åˆªé™¤å¤±æ•—ï¼š${error.message}`;
                    console.error("åˆªé™¤éŒ¯èª¤:", error);
                }
                showMessage(displayMessage, 'error');
            }
        };


        // -------------------------------------------------------------
        // 6. ç‹€æ…‹ç›£è½å™¨
        // -------------------------------------------------------------

        /**
         * Firebase èªè­‰ç‹€æ…‹æ”¹è®Šç›£è½å™¨
         */
        onAuthStateChanged(auth, async (user) => {
            isUserReauthenticated = false; // ç‹€æ…‹æ”¹è®Šæ™‚ï¼Œé‡ç½®é©—è­‰ç‹€æ…‹

            if (user) {
                // å·²ç™»å…¥
                currentUserEmailSpan.textContent = user.email;
                logoutButton.classList.remove('hidden');
                
                // æª¢æŸ¥é©—è­‰ç‹€æ…‹
                verificationStatusSpan.textContent = user.emailVerified ? 'å·²é©—è­‰ âœ…' : 'æœªé©—è­‰ âŒ';
                verificationStatusSpan.classList.toggle('text-green-500', user.emailVerified);
                verificationStatusSpan.classList.toggle('text-red-500', !user.emailVerified);
                verifyButton.disabled = user.emailVerified;
                
                // *** é¡¯ç¤ºç”¨æˆ¶è§’è‰² ***
                const role = await getUserRole(user);
                currentUserEmailSpan.textContent += ` (è§’è‰²: ${role})`;

                // åªæœ‰åœ¨ management view æ‰æ›´æ–°åˆªé™¤æŒ‰éˆ•ç‹€æ…‹
                if (document.getElementById('management-view').classList.contains('hidden') === false) {
                    updateDeleteView(user);
                }
                
            } else {
                // æœªç™»å…¥
                currentUserEmailSpan.textContent = 'æœªç™»å…¥';
                logoutButton.classList.add('hidden');
                verificationStatusSpan.textContent = 'æœªè¼‰å…¥';
                
                // è·³è½‰å›ç™»å…¥é é¢
                showView('login'); 
            }
        });

    </script>
</body>
</html>
