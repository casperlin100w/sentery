<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星崔AI - 用戶資料</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght=100..900&display=swap" rel="stylesheet">
    <style>
        /* 自定義字體設定 */
        :root {
            font-family: 'Inter', sans-serif;
        }

        /* 隱藏預設的下拉箭頭 */
        .dropdown-menu {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        /* 鼠標懸停時顯示菜單 */
        .dropdown:hover .dropdown-menu {
            display: block;
            opacity: 1;
        }

        /* 按鈕點擊動畫效果 (使用 Tailwind 的 scale 和 duration) */
        .button-click-effect:active {
            transform: scale(0.95);
            transition: transform 0.05s ease-out;
        }

        /* 漢堡選單滑入效果 */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            /* 預設隱藏在左側 */
            z-index: 50;
            background-color: white;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 80%;
            /* 佔用 80% 寬度 */
            max-width: 300px;
            padding-top: 6rem;
            /* 避開頂部導航欄 */
        }

        .sidebar.active {
            transform: translateX(0);
            /* 滑入 */
        }

        /* 內容切換的滑動效果 */
        .content-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .status-container {
            display: flex;
            /* 啟用 Flexbox */
            align-items: center;
            /* (可選) 讓內容在垂直方向上對齊 */
            /* 如果需要它們之間有間距，可以使用 gap: 10px; */
        }


        /* 確保 body 覆蓋整個視窗 */
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f7f7f7;
            /* 使用淡灰色作為整體背景，白色為內容背景 */
        }

        /* 讓主內容區塊可以佔滿剩餘空間 */
        #main-content {
            flex-grow: 1;
        }
    </style>
</head>

<body class="bg-white">

    <div id="sidebar" class="sidebar shadow-xl lg:hidden">
        <nav class="flex flex-col p-4 space-y-2">
        </nav>
    </div>

    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">

            <button id="hamburger-btn"
                class="text-gray-700 hover:text-gray-900 focus:outline-none lg:hidden button-click-effect text-2xl p-1 rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="w-6 h-6">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>

            <div class="flex items-center space-x-2 ml-2 lg:mr-0">
                <button onclick="navigate('dashboard', 'home')"
                    class="text-gray-700 hover:text-blue-600 focus:outline-none button-click-effect p-1 rounded-md transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="w-6 h-6">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold text-gray-900"><a href="../">星崔AI</a></h1>
            </div>

            <nav id="desktop-menu" class="hidden lg:flex space-x-2">

                <div class="dropdown relative group">
                    <button
                        class="flex items-center p-3 text-gray-700 hover:text-gray-900 font-medium cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect">
                        帳號與設定
                    </button>
                    <div
                        class="dropdown-menu absolute left-0 w-56 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-20">
                        <a href="#profile-tutorial" data-tab="settings"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 button-click-effect dropdown-item">設定</a>
                        <a href="#profile-tutorial" data-tab="account"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 button-click-effect dropdown-item">帳號</a>
                    </div>
                </div>

                <button onclick="navigate('tutorial-page', 'tutorial')"
                    class="p-3 text-gray-700 hover:text-gray-900 font-medium cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect">
                    使用教學
                </button>

                <button onclick="navigate('dashboard', 'data')"
                    class="p-3 text-gray-700 hover:text-gray-900 font-medium cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect">
                    我的數據
                </button>

                <div class="dropdown relative group">
                    <button
                        class="flex items-center p-3 text-gray-700 hover:text-gray-900 font-medium cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect">
                        技術人員
                    </button>
                    <div
                        class="dropdown-menu absolute left-0 w-56 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-20">
                        <a href="#profile-tutorial" data-tab="productStatement"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 button-click-effect dropdown-item">產品聲明</a>
                        <a href="#profile-tutorial" data-tab="reportIssue"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 button-click-effect dropdown-item">回報問題</a>
                    </div>
                </div>

                <div class="dropdown relative group">
                    <button
                        class="flex items-center p-3 text-green-700 hover:text-gray-900 font-medium cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect">
                        已登入
                    </button>
                    <div
                        class="dropdown-menu absolute right-0 w-56 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-20">
                        <button id="logout-btn"
                            class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 button-click-effect">
                            登出
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main id="main-content" class="p-4 sm:p-6 lg:p-8 flex-grow bg-gray-50">
        <div id="view-dashboard" class="content-transition p-8 bg-white shadow-xl rounded-xl">
            <h2 class="text-3xl font-semibold text-gray-800 mb-4">歡迎回來！</h2>
            <p class="text-gray-600">這是您的主儀表板。請從上方或左側菜單選擇功能。</p>
            <div class="mt-8 p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded">
                <div class="status-container">
                    <p class="font-bold">Firebase 狀態:</p>
                    <p id="auth-status">載入中...</p>
                </div>
                <p id="user-info"></p>
                <p id="nickname-display"></p>
            </div>
        </div>

        <div id="view-tutorial-page"
            class="content-transition p-4 md:p-8 bg-white shadow-xl rounded-xl mx-auto max-w-4xl"
            style="display:none; opacity: 0; transform: translateY(20px);">
            <h2 class="text-3xl font-semibold text-blue-700 mb-6 border-b pb-2">星崔AI教程</h2>
            <p class="text-gray-700 mb-4">歡迎來到星崔AI的教學頁面！在這裡您可以找到所有功能的詳細操作指南、常見問題解答和最佳實踐。</p>

            <div class="space-y-6 mt-8">
                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800">快速入門 (5 分鐘)</h3>
                    <p class="text-gray-600 mt-2">如果您是新用戶，請先觀看我們的快速入門影片，快速了解主要功能。</p>
                    <button
                        class="mt-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition button-click-effect">
                        觀看教學影片
                    </button>
                </div>

                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800">常見功能操作</h3>
                    <ul class="list-disc list-inside ml-4 mt-2 text-gray-700 space-y-1">
                        <li>如何修改個人暱稱和資料？ (請參閱「帳號」頁面)</li>
                        <li>如何查詢歷史數據？ (請點擊「我的數據」)</li>
                        <li>遇到問題時如何回報？ (請參閱「技術人員」下拉菜單)</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="view-profile-tutorial"
            class="content-transition p-4 md:p-8 bg-white shadow-xl rounded-xl mx-auto max-w-4xl"
            style="display:none; opacity: 0; transform: translateY(20px);">
            <h2 class="text-3xl font-semibold text-gray-800 mb-6 border-b pb-2">帳號與設定</h2>

            <div id="profile-greeting-container"
                class="mb-8 p-6 bg-blue-50 border-l-4 border-blue-400 rounded-lg shadow-sm">
                <h4 class="text-2xl md:text-3xl font-bold text-blue-800">
                    載入中...
                </h4>
            </div>

            <div class="flex flex-wrap justify-start space-x-2 md:space-x-4 mb-8 border-b-2 border-gray-200">
            </div>

            <div id="profile-tutorial-content" class="min-h-[400px] p-4 border rounded-lg bg-white">
            </div>
        </div>

        <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold mb-3 text-gray-800">通知</h3>
                <p id="modal-message" class="text-gray-700 mb-4"></p>
                <button onclick="closeModal()"
                    class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition button-click-effect">確認</button>
            </div>
        </div>
    </main>

    <script type="module">
        // 1. Firebase 核心庫導入
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // *** 修正: 導入 sendPasswordResetEmail 模組 ***
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設置 Firebase Log 等級 (用於調試)
        setLogLevel('debug');

        // 2. 獲取全域環境變數 (強制要求使用)
        const FIREBASE_API_KEY = "AIzaSyCtbjdi-x3E3eNgX8WvBtgibOTRG4idny4"; // 假設這是您的 API Key
        const FIREBASE_PROJECT_ID = "workai-1d692"; // 假設這是您的 Project ID
        const FIREBASE_APP_ID = "1:156453625217:web:f04e2da964ddb6d449dc80"; // 假設這是您的 App ID

        const appId = FIREBASE_PROJECT_ID; // 使用 Project ID 作為 appId
        const firebaseConfig = {
            apiKey: FIREBASE_API_KEY,
            authDomain: `${FIREBASE_PROJECT_ID}.firebaseapp.com`,
            projectId: FIREBASE_PROJECT_ID,
            storageBucket: `${FIREBASE_PROJECT_ID}.firebasestorage.app`,
            messagingSenderId: "156453625217",
            appId: FIREBASE_APP_ID
        };
        const initialAuthToken = null; // 暫時移除動態 token 載入

        // 3. 全域變數初始化
        let app, db, auth;
        let userId = 'loading'; // 預設狀態
        let currentView = 'dashboard';
        let currentTab = 'settings'; // 預設子頁面 tab
        let currentNickname = '載入中';
        let isLoggingOut = false;

        // 導航標籤配置 (已更新名稱和結構)
        const navTabs = {
            'settings': { title: '設定', parent: '帳號與設定', content: '這是帳號設定的詳細內容。' },
            'account': { title: '帳號', parent: '帳號與設定', content: '這是帳號管理的詳細內容。' },
            'productStatement': { title: '產品聲明', parent: '技術人員', content: '這是產品的公開聲明與條款。' },
            'reportIssue': { title: '回報問題', parent: '技術人員', content: '這是回報問題的聯繫表單或說明。' }
        };

        // DOM 元素 (部分元素不再需要，但保留方便調試)
        const $dashboard = document.getElementById('view-dashboard');
        const $profileTutorial = document.getElementById('view-profile-tutorial'); // 實際為「帳號與設定」
        const $tutorialPage = document.getElementById('view-tutorial-page'); // 獨立的教學頁面
        const $contentArea = document.getElementById('profile-tutorial-content');
        const $profileGreetingContainer = document.getElementById('profile-greeting-container'); // 新增的問候語容器
        const $userInfo = document.getElementById('user-info');
        const $authStatus = document.getElementById('auth-status');
        const $hamburgerBtn = document.getElementById('hamburger-btn');
        const $sidebar = document.getElementById('sidebar');
        const $logoutBtn = document.getElementById('logout-btn');

        // 訊息模態框
        const $modal = document.getElementById('message-modal');
        const $modalMessage = document.getElementById('modal-message');

        // 4. 模態框函數 (確保認證失敗時能正確轉跳)
        let afterCloseAction = null;

        function hideModal() {
            $modal.classList.remove('flex');
            $modal.classList.add('hidden');
        }

        function showModal(message, callback = null) {
            $modalMessage.textContent = message;
            $modal.classList.remove('hidden');
            $modal.classList.add('flex');
            afterCloseAction = callback;
        }

        window.closeModal = function () {
            hideModal();
            if (afterCloseAction) {
                afterCloseAction();
                afterCloseAction = null;
            }
        }


        // 5. Firebase 處理函數
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 認證邏輯：使用 custom token 或匿名登入
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    $authStatus.textContent = `已登入 `;
                    $userInfo.textContent = `用戶類型: ${user.isAnonymous ? '匿名' : '標準'}`;

                    setupNicknameListener(userId);
                    handleInitialNavigation();

                } else {
                    $authStatus.textContent = '未登入';
                    $userInfo.textContent = '';
                    if (isLoggingOut) {
                        console.log("偵測到登出中，跳過自動登入。");
                        return;
                    }

                    // 嘗試認證
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // 如果沒有登入狀態，嘗試匿名登入
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase 認證失敗:", error);
                        // *** 認證失敗時，提示錯誤後重定向到登入頁，邏輯不變 ***
                        const redirectMessage = `認證失敗: 系統無法完成身份驗證。錯誤代碼: ${error.code || '未知'}`;
                        const LOGIN_PAGE_URL = "../login";

                        showModal(redirectMessage, () => {
                            window.location.href = LOGIN_PAGE_URL;
                        });
                    }
                }
            });
        } catch (error) {
            console.error("Firebase 初始化失敗:", error);
            $authStatus.textContent = `Firebase 錯誤：初始化失敗 (${error.message})`;
        }


        /**
         * 渲染頂部的暱稱問候語區塊
         */
        function renderProfileGreeting() {
            if ($profileGreetingContainer) {
                $profileGreetingContainer.innerHTML = `
                <h4 class="text-2xl md:text-3xl font-bold text-blue-800">
                    您好，<span id="account-nickname-display">${currentNickname}</span>
                </h4>
            `;
            }
        }

        /**
         * 監聽並顯示使用者暱稱
         * @param {string} uid - 使用者 ID
         */
        function setupNicknameListener(uid) {
            const docRef = doc(db, `artifacts/${appId}/users/${uid}/profileData/mainProfile`);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentNickname = data.nickname || '新用戶';
                } else {
                    currentNickname = '新用戶';
                    setNickname('新用戶');
                }
                document.getElementById('nickname-display').textContent = `暱稱: ${currentNickname}`;
                if (currentView === 'profile-tutorial') {
                    renderProfileGreeting();
                }
                if (currentView === 'profile-tutorial' && currentTab === 'account') {
                    renderProfileTutorialContent();
                }
            }, (error) => {
                console.error("監聽暱稱失敗:", error);
                showModal(`無法載入暱稱數據，請檢查連線或 Firestore 權限。錯誤代碼: ${error.code || '未知'}(若您正在登出，請忽略此訊息)`);
            });
        }

        /**
         * 儲存新的使用者暱稱到 Firestore
         * @param {string} newNickname - 新的暱稱
         */
        window.setNickname = async function (newNickname) {
            if (!userId || userId === 'loading') return showModal('用戶狀態未就緒，無法儲存。');

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/profileData/mainProfile`);
            try {
                await setDoc(docRef, { nickname: newNickname }, { merge: true });
                showModal(`暱稱已更新為: ${newNickname}`);
            } catch (error) {
                console.error("更新暱稱失敗:", error);
                showModal(`更新暱稱失敗: ${error.message}`);
            }
        }

        // 6. 導航邏輯

        /**
         * 處理主菜單點擊 (桌面/側邊欄)
         * @param {string} targetView - 目標視圖 ('dashboard', 'profile-tutorial', or 'tutorial-page')
         * @param {string} tabKey - 子項目的鍵值 ('home', 'data', 'settings', 'account', 'tutorial'...)
         */
        window.navigate = function (targetView, tabKey) {
            // 1. 處理特殊動作 (登出/回首頁/數據)
            if (tabKey === 'logout') {
                handleSignOut();
                return;
            }

            if (tabKey === 'home' || tabKey === 'data') {
                currentView = 'dashboard';
            }
            // 2. 處理跳轉到獨立教學頁
            else if (targetView === 'tutorial-page') {
                currentView = 'tutorial-page';
            }
            // 3. 處理跳轉到子頁面 (帳號與設定 / 技術人員)
            else if (targetView === 'profile-tutorial') {
                currentTab = tabKey;
                currentView = 'profile-tutorial';
            }

            // 渲染並更新 Hash
            renderView();

            // 關閉側邊欄
            $sidebar.classList.remove('active');

            // 更新 URL hash
            let hash = `#${currentView}`;
            if (currentView === 'profile-tutorial') {
                hash += `:${currentTab}`;
            }
            window.location.hash = hash;
        }

        /**
         * 渲染當前視圖 (主頁、子頁或教學頁)
         */
        function renderView() {
            const views = [
                { el: $dashboard, name: 'dashboard' },
                { el: $profileTutorial, name: 'profile-tutorial' },
                { el: $tutorialPage, name: 'tutorial-page' }
            ];

            views.forEach(view => {
                const isActive = view.name === currentView;

                if (isActive) {
                    view.el.style.display = 'block';
                    setTimeout(() => {
                        view.el.style.opacity = '1';
                        view.el.style.transform = 'translateY(0)';

                        if (view.name === 'profile-tutorial') {
                            renderProfileGreeting();
                            renderProfileTutorialContent();
                        }
                    }, 10);
                } else {
                    view.el.style.opacity = '0';
                    view.el.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        view.el.style.display = 'none';
                    }, 300);
                }
            });
        }

        /**
         * 處理密碼重設邏輯 (新增函式)
         */
        window.handlePasswordReset = async function () {
            const user = auth.currentUser;

            if (!user || user.isAnonymous) {
                showModal('您必須使用電子郵件/密碼登入的帳號才能重設密碼。');
                return;
            }

            const email = user.email;

            if (!email) {
                showModal('無法獲取您的電子郵件地址，請檢查帳號資訊或重新登入。');
                return;
            }

            const confirmation = confirm(`確定要將密碼重設郵件發送到您的帳號電子郵件：${email} 嗎？`);

            if (!confirmation) return;

            showModal(`正在為 ${email} 寄送密碼重設郵件...`, null); // 顯示處理中訊息

            try {
                await sendPasswordResetEmail(auth, email);
                showModal(`✅ 密碼重設郵件已發送至 ${email}。請檢查您的收件箱！`);
            } catch (error) {
                console.error("密碼重設錯誤:", error);
                showModal(`❌ 密碼重設失敗：${error.message}`);
            }
        };

        /**
         * 渲染子頁面 (帳號與設定) 的內容和導航列
         */
        function renderProfileTutorialContent() {
            const $navBar = $profileTutorial.querySelector('.flex-wrap');
            $navBar.innerHTML = '';

            const relevantTabs = Object.entries(navTabs).filter(([key, value]) => {
                return ['settings', 'account', 'productStatement', 'reportIssue'].includes(key);
            });


            relevantTabs.forEach(([key, value]) => {
                const isActive = key === currentTab;
                const button = document.createElement('button');
                button.textContent = value.title;
                button.dataset.tab = key;
                button.className = `p-2 px-4 font-medium text-gray-700 hover:text-blue-600 transition duration-150 button-click-effect 
                                ${isActive ? 'border-b-2 border-blue-600 text-blue-600' : 'hover:border-b-2 hover:border-blue-300'}`;

                button.onclick = () => {
                    if (currentTab === key) return;
                    currentTab = key;
                    renderProfileTutorialContent();
                    window.location.hash = `#profile-tutorial:${currentTab}`;
                };

                $navBar.appendChild(button);
            });

            // 渲染內容區
            $contentArea.style.opacity = '0';
            $contentArea.style.transform = 'translateX(-20px)';

            setTimeout(() => {
                let contentHTML = '';
                const tabTitle = navTabs[currentTab] ? navTabs[currentTab].title : '未知標籤';

                if (currentTab === 'account') {
                    contentHTML = `

                    <h4 class="text-2xl font-semibold mb-4 text-blue-700">${tabTitle} </h4>
                    <p class="mb-8 text-gray-600 mt-4">其他帳號相關資訊，例如電子郵件、會員等級等...</p>
                    
                    <div class="mb-8 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-lg shadow-sm">
                        <h5 class="text-xl font-medium mb-2 text-blue-800">修改暱稱</h5>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-medium text-blue-800 flex items-center">
                                目前暱稱: ${currentNickname}
                            </span>
                            
                            <button id="edit-nickname-btn" class="text-blue-500 hover:text-blue-700 button-click-effect p-1 rounded-full bg-white shadow">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    class="w-5 h-5">
                                    <path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-8 p-4 bg-red-50 border-l-4 border-red-400 text-red-800 rounded-lg shadow-sm">
                        <h5 class="text-xl font-medium mb-2">密碼重設</h5>
                        <p class="text-sm mb-3">
                            點擊下方按鈕，系統會將密碼重設連結寄送到您當前的帳號電子郵件地址。
                        </p>
                        <button id="reset-password-btn"
                            class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition button-click-effect">
                            發送密碼重設郵件
                        </button>
                    </div>
                  
                    <div class="mb-8 p-4 bg-gray-50 border-l-4 border-gray-400 text-gray-800 rounded-lg shadow-sm">
                        <h5 class="text-xl font-medium mb-2">帳號編碼</h5>
                        <p class="text-sm mb-3">
                            ${userId}
                        </p>
                    </div>
                `;

                } else if (currentTab === 'reportIssue') {
                    contentHTML = `
                    <h4 class="text-2xl font-semibold mb-4 text-blue-700">${tabTitle} </h4>
                    <p class="text-gray-600 mb-4">請在下方表單填寫您遇到的問題，我們會盡快處理。</p>
                    <div id="error-form-container" class="border border-gray-200 p-4 rounded-lg bg-gray-50">
                        <p class="text-center text-gray-500">載入表單中...</p>
                    </div>
                `;

                } else {
                    contentHTML = `
                    <h4 class="text-2xl font-semibold mb-4 text-blue-700">${tabTitle} </h4>
                    <p class="text-gray-600">${navTabs[currentTab].content}</p>
                    <div class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded">
                        <p class="font-bold">內容提示:</p>
                        <p>這是 ${tabTitle} 的預留內容。請在此處添加具體的 UI/表單。</p>
                    </div>
                `;
                }


                $contentArea.innerHTML = contentHTML;
                $contentArea.style.opacity = '1';
                $contentArea.style.transform = 'translateX(0)';


                if (currentTab === 'account') {
                    const $editNicknameBtn = document.getElementById('edit-nickname-btn');
                    if ($editNicknameBtn) {
                        $editNicknameBtn.addEventListener('click', handleNicknameEdit);
                    }
                    // *** 新增密碼重設按鈕的事件監聽器 ***
                    const $resetPasswordBtn = document.getElementById('reset-password-btn');
                    if ($resetPasswordBtn) {
                        $resetPasswordBtn.addEventListener('click', window.handlePasswordReset);
                    }
                }

                else if (currentTab === 'reportIssue') {
                    const $formContainer = document.getElementById('error-form-container');
                    if ($formContainer) {
                        fetch('errorform.html')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
                                }
                                return response.text();
                            })
                            .then(html => {
                                $formContainer.innerHTML = html;
                            })
                            .catch(error => {
                                console.error("載入 errorform.html 失敗:", error);
                                $formContainer.innerHTML = `<p class="text-red-500 font-bold">載入表單失敗，請檢查 errorform.html 檔案是否存在於同一目錄或路徑是否正確。</p>`;
                            });
                    }
                }
            }, 100);


        }

        /**
         * 處理 URL Hash 導航
         */
        function handleInitialNavigation() {
            const hash = window.location.hash.slice(1);

            if (hash === 'dashboard' || hash === '') {
                currentView = 'dashboard';
            } else if (hash === 'tutorial-page') {
                currentView = 'tutorial-page';
            } else if (hash.startsWith('profile-tutorial')) {
                const parts = hash.split(':');
                const view = parts[0];
                const tab = parts[1] || 'settings';

                if (['settings', 'account', 'productStatement', 'reportIssue'].includes(tab)) {
                    currentView = view;
                    currentTab = tab;
                } else {
                    currentView = 'dashboard';
                }
            } else {
                currentView = 'dashboard';
            }

            renderView();
        }

        /**
         * 處理暱稱編輯邏輯 (彈出視窗)
         */
        function handleNicknameEdit() {
            const newName = prompt("請輸入新的暱稱:", currentNickname);

            if (newName && newName.trim() !== '' && newName !== currentNickname) {
                window.setNickname(newName.trim());
            } else if (newName !== null) {
                showModal("暱稱未修改或輸入無效。");
            }
        }

        // 7. 事件監聽器

        // 點擊事件代理 (處理所有桌面菜單子項目的點擊)
        document.addEventListener('click', (e) => {
            const item = e.target.closest('.dropdown-item');
            if (item) {
                e.preventDefault();
                const tab = item.dataset.tab;
                navigate('profile-tutorial', tab);
            }
        });

        // 漢堡菜單切換 (點擊按鈕開啟或關閉)
        $hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            $sidebar.classList.toggle('active');
        });

        // 點擊側邊欄外部區域時關閉側邊欄
        document.addEventListener('click', (e) => {
            const isClickInsideSidebar = $sidebar.contains(e.target);
            const isClickOnHamburger = $hamburgerBtn.contains(e.target) || e.target === $hamburgerBtn;

            if ($sidebar.classList.contains('active') && !isClickInsideSidebar && !isClickOnHamburger) {
                $sidebar.classList.remove('active');
            }
        });

        // 登出按鈕
        async function handleSignOut() {
            if (!auth) {
                showModal("登出失敗：應用程式初始化錯誤。");
                return;
            }

            try {
                isLoggingOut = true;
                await signOut(auth);

                // *** 修正登出成功後的轉跳路徑為上層資料夾 (../) ***
                const HOMEPAGE_URL = "../";
                window.location.href = HOMEPAGE_URL;

            } catch (error) {
                console.error("登出失敗:", error);
                showModal(`登出失敗: ${error.message}`);
            }
        }
        $logoutBtn.addEventListener('click', handleSignOut);

        // 8. 程式啟動
        window.addEventListener('load', () => {
            generateSidebarMenu();
        });

        // 9. 側邊欄生成函數 (已修正 Maps 函數呼叫為 navigate)
        // 側邊欄菜單數據
        const menuData = [
            {
                title: '我的數據',
                target: 'dashboard',
                tab: 'data'
            },
            {
                title: '使用教學',
                target: 'tutorial-page',
                tab: 'tutorial'
            },
            {
                title: '帳號與設定',
                target: 'profile-tutorial',
                items: [
                    { name: '設定', tab: 'settings' },
                    { name: '帳號', tab: 'account' }
                ]
            },
            {
                title: '技術人員',
                target: 'profile-tutorial',
                items: [
                    { name: '產品聲明', tab: 'productStatement' },
                    { name: '回報問題', tab: 'reportIssue' }
                ]
            },
            {
                title: '登出',
                target: 'dashboard',
                tab: 'logout'
            }
        ];

        function generateSidebarMenu() {
            const nav = $sidebar.querySelector('nav');
            nav.innerHTML = '';

            menuData.forEach(mainItem => {
                if (mainItem.items) {
                    // 有子項目的菜單 (Accordion Style)
                    const details = document.createElement('details');
                    const summary = document.createElement('summary');
                    const subMenu = document.createElement('div');

                    details.className = 'py-2';
                    summary.className = 'p-3 text-lg font-medium text-gray-700 hover:text-gray-900 cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect';
                    summary.textContent = mainItem.title;
                    subMenu.className = 'ml-4 mt-1 space-y-1';

                    mainItem.items.forEach(subItem => {
                        const link = document.createElement('a');

                        let onclickAction;
                        let href;

                        if (subItem.tab === 'logout') {
                            onclickAction = `Maps('dashboard', 'logout')`;
                            href = '#';
                        } else {
                            // *** 修正 Maps 為 navigate ***
                            onclickAction = `Maps('profile-tutorial', '${subItem.tab}')`;
                            href = `#profile-tutorial:${subItem.tab}`;
                        }

                        link.setAttribute('onclick', onclickAction);
                        link.href = href;
                        link.className = 'block px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md button-click-effect';
                        link.textContent = subItem.name;
                        subMenu.appendChild(link);
                    });

                    details.appendChild(summary);
                    details.appendChild(subMenu);
                    nav.appendChild(details);
                } else {
                    // 無子項目的菜單 (使用教學 / 我的數據 / 登出)
                    const button = document.createElement('button');
                    button.textContent = mainItem.title;
                    button.className = 'w-full text-left p-3 text-lg font-medium text-gray-700 hover:text-gray-900 cursor-pointer rounded-lg bg-gray-50 hover:bg-gray-100 transition button-click-effect';

                    // 獨立按鈕直接導航到其目標 view
                    // *** 修正 Maps 為 navigate ***
                    button.setAttribute('onclick', `Maps('${mainItem.target}', '${mainItem.tab}')`);

                    // 登出按鈕特別處理
                    if (mainItem.tab === 'logout') {
                        button.classList.add('text-red-600', 'hover:text-red-700', 'bg-red-50');
                    }

                    nav.appendChild(button);
                }
            });
        }


        // 10. URL hash 變化時，重新導航
        window.addEventListener('hashchange', handleInitialNavigation);

    </script>
</body>

</html>