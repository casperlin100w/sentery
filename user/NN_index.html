<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星崔AI - 登入後畫面</title>
    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Google Inter 字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght=100..900&display=swap" rel="stylesheet">
    <style>
        /* 自定義字體設定 */
        :root {
            font-family: 'Inter', sans-serif;
        }

        /* 隱藏預設的下拉箭頭 */
        .dropdown-menu {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        /* 鼠標懸停時顯示菜單 */
        .dropdown:hover .dropdown-menu {
            display: block;
            opacity: 1;
        }

        /* 按鈕點擊動畫效果 (使用 Tailwind 的 scale 和 duration) */
        .button-click-effect:active {
            transform: scale(0.95);
            transition: transform 0.05s ease-out;
        }

        /* 漢堡選單滑入效果 */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            /* 預設隱藏在左側 */
            z-index: 50;
            background-color: white;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 80%;
            /* 佔用 80% 寬度 */
            max-width: 300px;
            padding-top: 6rem;
            /* 避開頂部導航欄 */
        }

        .sidebar.active {
            transform: translateX(0);
            /* 滑入 */
        }

        /* 內容切換的滑動效果 */
        .content-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        /* 確保 body 覆蓋整個視窗 */
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f7f7f7;
            /* 使用淡灰色作為整體背景，白色為內容背景 */
        }

        /* 讓主內容區塊可以佔滿剩餘空間 */
        #main-content {
            flex-grow: 1;
        }
    </style>
</head>

<body class="bg-white">

    <!-- 側邊欄/漢堡選單 (小螢幕) -->
    <div id="sidebar" class="sidebar shadow-xl lg:hidden">
        <nav class="flex flex-col p-4 space-y-2">
            <!-- 側邊欄選單項目將由 JS 生成 -->
        </nav>
    </div>

    <!-- 頂部導航欄 (白色區塊) -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">

            <!-- 漢堡菜單按鈕 (小螢幕顯示) -->
            <button id="hamburger-btn"
                class="text-gray-700 hover:text-gray-900 focus:outline-none lg:hidden button-click-effect text-2xl p-1 rounded-md">
                <!-- 漢堡圖案 (三) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="w-6 h-6">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>

            <!-- Home Button & H1 標題 -->
            <!-- 新增一個 flex 容器來包含 Home Icon 和 H1 -->
            <div class="flex items-center space-x-2 mr-auto lg:mr-0 lg:ml-4">
                <!-- Home Button (小房子圖案) - 點擊回到儀表板 -->
                <button onclick="navigate('dashboard', 'home')"
                    class="text-gray-700 hover:text-blue-600 focus:outline-none button-click-effect p-1 rounded-md transition duration-150">
                    <!-- Home Icon (使用 lucide-icon 的 house 圖案) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="w-6 h-6">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </button>
                <h1 class="text-2xl font-bold text-gray-900">星崔AI</h1>
            </div>

            <!-- 桌面版下拉菜單 (大螢幕顯示) -->
            <nav id="desktop-menu" class="hidden lg:flex space-x-2">

                <!-- 菜單：帳號與設定 (Dropdown) - 原「個人資料」 -->
                <div class="dropdown relative group">
                    <button
                        class="flex items-center p-3 text-gray-700 hover:text-gray-900 font-medium cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect">
                        帳號與設定
                    </button>
                    <div
                        class="dropdown-menu absolute left-0 w-56 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-20">
                        <a href="#profile-tutorial" data-tab="settings"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 button-click-effect dropdown-item">設定</a>
                        <a href="#profile-tutorial" data-tab="account"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 button-click-effect dropdown-item">帳號</a>
                    </div>
                </div>

                <!-- 菜單：使用教學 (單一按鈕) - 點擊跳轉到獨立頁面 -->
                <button onclick="navigate('tutorial-page', 'tutorial')"
                    class="p-3 text-gray-700 hover:text-gray-900 font-medium cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect">
                    使用教學
                </button>

                <!-- 菜單：我的數據 (無子項目，直接導航或顯示) -->
                <button onclick="navigate('dashboard', 'data')"
                    class="p-3 text-gray-700 hover:text-gray-900 font-medium cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect">
                    我的數據
                </button>

                <!-- 菜單：技術人員 (Dropdown) -->
                <div class="dropdown relative group">
                    <button
                        class="flex items-center p-3 text-gray-700 hover:text-gray-900 font-medium cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect">
                        技術人員
                    </button>
                    <div
                        class="dropdown-menu absolute left-0 w-56 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-20">
                        <a href="#profile-tutorial" data-tab="productStatement"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 button-click-effect dropdown-item">產品聲明</a>
                        <a href="#profile-tutorial" data-tab="reportIssue"
                            class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 button-click-effect dropdown-item">回報問題</a>
                    </div>
                </div>

                <!-- 菜單：已登入 (Dropdown) -->
                <div class="dropdown relative group">
                    <button
                        class="flex items-center p-3 text-green-700 hover:text-gray-900 font-medium cursor-pointer rounded-lg bg-white hover:bg-gray-100 transition button-click-effect">
                        已登入
                    </button>
                    <div
                        class="dropdown-menu absolute right-0 w-56 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 z-20">
                        <button id="logout-btn"
                            class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 button-click-effect">
                            登出
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- 主內容區塊 -->
    <main id="main-content" class="p-4 sm:p-6 lg:p-8 flex-grow bg-gray-50">
        <!-- 儀表板畫面 (預設) -->
        <div id="view-dashboard" class="content-transition p-8 bg-white shadow-xl rounded-xl">
            <h2 class="text-3xl font-semibold text-gray-800 mb-4">歡迎回來！</h2>
            <p class="text-gray-600">這是您的主儀表板。請從上方或左側菜單選擇功能。</p>
            <div class="mt-8 p-4 bg-blue-50 border-l-4 border-blue-400 text-blue-800 rounded">
                <p class="font-bold">Firebase 狀態:</p>
                <p id="auth-status">載入中...</p>
                <p id="user-info"></p>
                <p id="nickname-display"></p>
            </div>
        </div>

        <!-- 星崔AI教程畫面 (新增的獨立頁面) -->
        <div id="view-tutorial-page"
            class="content-transition p-4 md:p-8 bg-white shadow-xl rounded-xl mx-auto max-w-4xl"
            style="display:none; opacity: 0; transform: translateY(20px);">
            <h2 class="text-3xl font-semibold text-blue-700 mb-6 border-b pb-2">星崔AI教程</h2>
            <p class="text-gray-700 mb-4">歡迎來到星崔AI的教學頁面！在這裡您可以找到所有功能的詳細操作指南、常見問題解答和最佳實踐。</p>

            <div class="space-y-6 mt-8">
                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800">快速入門 (5 分鐘)</h3>
                    <p class="text-gray-600 mt-2">如果您是新用戶，請先觀看我們的快速入門影片，快速了解主要功能。</p>
                    <button
                        class="mt-3 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition button-click-effect">
                        觀看教學影片
                    </button>
                </div>

                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50 shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800">常見功能操作</h3>
                    <ul class="list-disc list-inside ml-4 mt-2 text-gray-700 space-y-1">
                        <li>如何修改個人暱稱和資料？ (請參閱「帳號」頁面)</li>
                        <li>如何查詢歷史數據？ (請點擊「我的數據」)</li>
                        <li>遇到問題時如何回報？ (請參閱「技術人員」下拉菜單)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 帳號與設定畫面 (原 個資與教學) -->
        <div id="view-profile-tutorial"
            class="content-transition p-4 md:p-8 bg-white shadow-xl rounded-xl mx-auto max-w-4xl"
            style="display:none; opacity: 0; transform: translateY(20px);">
            <h2 class="text-3xl font-semibold text-gray-800 mb-6 border-b pb-2">帳號與設定</h2>

            <!-- 區塊一：暱稱問候大標題 (新位置) -->
            <!-- 此區塊將由 renderProfileGreeting() 填充內容 -->
            <div id="profile-greeting-container"
                class="mb-8 p-6 bg-blue-50 border-l-4 border-blue-400 rounded-lg shadow-sm">
                <h4 class="text-2xl md:text-3xl font-bold text-blue-800">
                    載入中...
                </h4>
            </div>

            <!-- 區塊二：子項目導航列 -->
            <div class="flex flex-wrap justify-start space-x-2 md:space-x-4 mb-8 border-b-2 border-gray-200">
                <!-- 導航項目將在 JS 中生成，以確保一致性 -->
            </div>

            <!-- 區塊三：子項目內容區 -->
            <div id="profile-tutorial-content" class="min-h-[400px] p-4 border rounded-lg bg-white">
                <!-- 內容將根據選定的 tab 顯示 -->
            </div>
        </div>

        <!-- 訊息彈出視窗 (用於代替 alert) -->
        <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold mb-3 text-gray-800">通知</h3>
                <p id="modal-message" class="text-gray-700 mb-4"></p>
                <button onclick="closeModal()"
                    class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition button-click-effect">確認</button>
            </div>
        </div>
    </main>

    <script type="module">
        // 1. Firebase 核心庫導入
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設置 Firebase Log 等級 (用於調試)
        setLogLevel('debug');

        // 2. 獲取全域環境變數 (強制要求使用)
        const FIREBASE_API_KEY = "AIzaSyCtbjdi-x3E3eNgX8WvBtgibOTRG4idny4"; // 假設這是您的 API Key
        const FIREBASE_PROJECT_ID = "workai-1d692"; // 假設這是您的 Project ID
        const FIREBASE_APP_ID = "1:156453625217:web:f04e2da964ddb6d449dc80"; // 假設這是您的 App ID

        const appId = FIREBASE_PROJECT_ID; // 使用 Project ID 作為 appId
        const firebaseConfig = {
            apiKey: FIREBASE_API_KEY,
            authDomain: `${FIREBASE_PROJECT_ID}.firebaseapp.com`,
            projectId: FIREBASE_PROJECT_ID,
            storageBucket: `${FIREBASE_PROJECT_ID}.firebasestorage.app`,
            messagingSenderId: "156453625217",
            appId: FIREBASE_APP_ID
        };
        const initialAuthToken = null; // 暫時移除動態 token 載入

        // 3. 全域變數初始化
        let app, db, auth;
        let userId = 'loading'; // 預設狀態
        let currentView = 'dashboard';
        let currentTab = 'settings'; // 預設子頁面 tab
        let currentNickname = '載入中';
        let isLoggingOut = false;
        let unsubscribeNicknameListener = null;

        const LOGIN_PAGE_URL = "../login/";
        const HOME_PAGE_URL = "../";

        // 導航標籤配置 (已更新名稱和結構)
        const navTabs = {
            'settings': { title: '設定', parent: '帳號與設定', content: '這是帳號設定的詳細內容。' },
            'account': { title: '帳號', parent: '帳號與設定', content: '這是帳號管理的詳細內容。' },
            'productStatement': { title: '產品聲明', parent: '技術人員', content: '這是產品的公開聲明與條款。' },
            'reportIssue': { title: '回報問題', parent: '技術人員', content: '這是回報問題的聯繫表單或說明。' }
            // '修改我的個人資料' (editProfile) 已經被移入 'account' 頁面內容中，不再是獨立導航標籤
        };

        // DOM 元素 (部分元素不再需要，但保留方便調試)
        const $dashboard = document.getElementById('view-dashboard');
        const $profileTutorial = document.getElementById('view-profile-tutorial'); // 實際為「帳號與設定」
        const $tutorialPage = document.getElementById('view-tutorial-page'); // 獨立的教學頁面
        const $contentArea = document.getElementById('profile-tutorial-content');
        const $profileGreetingContainer = document.getElementById('profile-greeting-container'); // 新增的問候語容器
        const $userInfo = document.getElementById('user-info');
        const $authStatus = document.getElementById('auth-status');
        const $hamburgerBtn = document.getElementById('hamburger-btn');
        const $sidebar = document.getElementById('sidebar');
        const $logoutBtn = document.getElementById('logout-btn');

        // 訊息模態框
        const $modal = document.getElementById('message-modal');
        const $modalMessage = document.getElementById('modal-message');

        // 4. 模態框函數
        /**
         * 顯示模態框通知，可設定是否自動關閉
         * @param {string} message - 顯示的訊息
         * @param {function} [callback] - 點擊確認後的回調函數 (如果顯示確認按鈕)
         * @param {boolean} [showConfirm=true] - 是否顯示確認按鈕
         * @param {number} [duration=0] - 自動關閉的延遲時間 (毫秒)，0 表示不自動關閉
         */

        function showModal(message, callback, showConfirm = true, duration = 0) {
            const $modal = document.getElementById('notification-modal');
            const $modalMessage = document.getElementById('modal-message');
            const $modalConfirm = document.getElementById('modal-confirm');

            if (!$modal || !$modalMessage || !$modalConfirm) {
                console.error("模態框元素缺失。無法顯示通知。");
                // 如果是登出，強制執行跳轉，避免用戶卡住
                if (callback && duration > 0) {
                    setTimeout(callback, duration);
                }
                return;
            }

            $modalMessage.textContent = message;
            $modalConfirm.style.display = showConfirm ? 'block' : 'none';

            // *** 修正：清空舊事件並分配新處理程序 (更穩定) ***
            $modalConfirm.onclick = null; // 清除舊的事件處理程序

            if (showConfirm) {
                $modalConfirm.onclick = () => {
                    $modal.classList.add('hidden');
                    if (callback) {
                        callback();
                    }
                };
            } else {
                // 如果沒有確認按鈕，點擊行為由自動關閉處理
                $modalConfirm.onclick = () => {
                    $modal.classList.add('hidden');
                };
            }

            $modal.classList.remove('hidden');

            // 處理自動關閉
            if (duration > 0) {
                setTimeout(() => {
                    $modal.classList.add('hidden');
                    if (callback) {
                        // 如果有 callback，且是無確認按鈕的自動關閉，則在這裡執行跳轉
                        callback();
                    }
                }, duration);
            }
        }

        window.closeModal = function () {
            $modal.classList.add('hidden');
            $modal.classList.remove('flex');
        }

        // 5. Firebase 處理函數
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 認證邏輯：使用 custom token 或匿名登入
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // 已登入
                    userId = user.uid;
                    $authStatus.textContent = `已登入 (UID: ${userId.substring(0, 8)}...)`;
                    $userInfo.textContent = `Email: ${user.email || 'N/A'}`;
                    setupNicknameListener(userId);
                    // 確保主內容可見
                    document.getElementById('main-content-area').style.display = 'block';
                    document.getElementById('loading-spinner').style.display = 'none';
                    // 處理初始導航
                    handleInitialNavigation();

                } else {
                    // 未登入
                    $authStatus.textContent = '未登入';
                    $userInfo.textContent = '';

                    // 1. 如果正在手動登出，則跳過 (讓登出流程完成)
                    if (isLoggingOut) {
                        console.log("偵測到登出中，跳過未登入檢查。");
                        return;
                    }

                    // 2. 核心修正：未登入時，提示並跳轉
                    console.error("未認證的用戶嘗試訪問登入後頁面。執行強制跳轉。");

                    // 顯示提示視窗 (帶有確認按鈕，強制用戶操作)
                    showModal("您尚未登入或登入已過期。請重新登入。", () => {
                        window.location.href = LOGIN_PAGE_URL;
                    });

                    // 隱藏主內容
                    document.getElementById('main-content-area').style.display = 'none';
                    document.getElementById('loading-spinner').style.display = 'none';
                }
            });
        } catch (error) {
            console.error("Firebase 初始化失敗:", error);
            $authStatus.textContent = `Firebase 錯誤：初始化失敗 (${error.message})`;
        }



        /**
         * 渲染頂部的暱稱問候語區塊
         */
        function renderProfileGreeting() {
            if ($profileGreetingContainer) {
                $profileGreetingContainer.innerHTML = `
                    <h4 class="text-2xl md:text-3xl font-bold text-blue-800">
                        您好，<span id="account-nickname-display">${currentNickname}</span>
                    </h4>
                `;
            }
        }

        /**
         * 監聽並顯示使用者暱稱
         * @param {string} uid - 使用者 ID
         */
        function setupNicknameListener(uid) {
            const docRef = doc(db, `artifacts/${appId}/users/${uid}/profileData/mainProfile`);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentNickname = data.nickname || '新用戶';
                } else {
                    currentNickname = '新用戶';
                    // 如果文件不存在，寫入一個預設值 (非必要，但能確保數據存在)
                    setNickname('新用戶');
                }
                // 無論如何，都要更新儀表板和問候語的顯示
                document.getElementById('nickname-display').textContent = `暱稱: ${currentNickname}`;

                // 如果在「帳號與設定」頁面，更新問候語
                if (currentView === 'profile-tutorial') {
                    renderProfileGreeting();
                }

                // 如果當前在 'account' 頁面，重新渲染以更新問候語內容（雖然問候語移出去了，但 account 內容可能需要最新的 currentNickname）
                if (currentView === 'profile-tutorial' && currentTab === 'account') {
                    renderProfileTutorialContent();
                }
            }, (error) => {
                // *** 修正：如果正在登出，則忽略此錯誤，不彈窗 ***
                if (isLoggingOut) return;

                console.error("監聽暱稱失敗:", error);
                showModal(`無法載入暱稱數據，請檢查連線或 Firestore 權限。錯誤代碼: ${error.code || '未知'}`);
            });
        }

        /**
         * 儲存新的使用者暱稱到 Firestore
         * @param {string} newNickname - 新的暱稱
         */
        window.setNickname = async function (newNickname) {
            if (!userId || userId === 'loading') return showModal('用戶狀態未就緒，無法儲存。');

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/profileData/mainProfile`);
            try {
                await setDoc(docRef, { nickname: newNickname }, { merge: true });
                // onSnapshot 會自動更新 currentNickname 和 UI
                showModal(`暱稱已更新為: ${newNickname}`);
            } catch (error) {
                console.error("更新暱稱失敗:", error);
                showModal(`更新暱稱失敗: ${error.message}`);
            }
        }

        // 6. 導航邏輯

        /**
         * 處理主菜單點擊 (桌面/側邊欄)
         * @param {string} targetView - 目標視圖 ('dashboard', 'profile-tutorial', or 'tutorial-page')
         * @param {string} tabKey - 子項目的鍵值 ('home', 'data', 'settings', 'account', 'tutorial'...)
         */
        window.navigate = function (targetView, tabKey) {
            // 1. 處理特殊動作 (登出/回首頁/數據)
            if (tabKey === 'logout') {
                handleSignOut();
                return;
            }

            if (tabKey === 'home' || tabKey === 'data') {
                currentView = 'dashboard';
            }
            // 2. 處理跳轉到獨立教學頁
            else if (targetView === 'tutorial-page') {
                currentView = 'tutorial-page';
            }
            // 3. 處理跳轉到子頁面 (帳號與設定 / 技術人員)
            else if (targetView === 'profile-tutorial') {
                currentTab = tabKey;
                currentView = 'profile-tutorial';
            }

            // 渲染並更新 Hash
            renderView();

            // 關閉側邊欄
            $sidebar.classList.remove('active');

            // 更新 URL hash
            let hash = `#${currentView}`;
            if (currentView === 'profile-tutorial') {
                hash += `:${currentTab}`;
            }
            window.location.hash = hash;
        }

        /**
         * 渲染當前視圖 (主頁、子頁或教學頁)
         */
        function renderView() {
            // 獲取所有主要的視圖元素
            const views = [
                { el: $dashboard, name: 'dashboard' },
                { el: $profileTutorial, name: 'profile-tutorial' },
                { el: $tutorialPage, name: 'tutorial-page' }
            ];

            views.forEach(view => {
                const isActive = view.name === currentView;

                // 應用過渡效果：先隱藏，再顯示
                if (isActive) {
                    view.el.style.display = 'block';
                    // 延遲應用過渡，確保 display: block 生效
                    setTimeout(() => {
                        view.el.style.opacity = '1';
                        view.el.style.transform = 'translateY(0)';

                        // 如果是「帳號與設定」頁面，確保問候語和內容被渲染
                        if (view.name === 'profile-tutorial') {
                            renderProfileGreeting(); // 新增：更新問候語
                            renderProfileTutorialContent();
                        }
                    }, 10);
                } else {
                    view.el.style.opacity = '0';
                    view.el.style.transform = 'translateY(20px)';
                    // 過渡結束後隱藏
                    setTimeout(() => {
                        view.el.style.display = 'none';
                    }, 300); // 應與 CSS transition 速度一致
                }
            });
        }

        /**
         * 渲染子頁面 (帳號與設定) 的內容和導航列
         */
        function renderProfileTutorialContent() {
            // 渲染頂部導航列 (邏輯保持不變)
            const $navBar = $profileTutorial.querySelector('.flex-wrap');
            $navBar.innerHTML = '';

            const relevantTabs = Object.entries(navTabs).filter(([key, value]) => {
                return ['settings', 'account', 'productStatement', 'reportIssue'].includes(key);
            });


            relevantTabs.forEach(([key, value]) => {
                const isActive = key === currentTab;
                const button = document.createElement('button');
                button.textContent = value.title;
                button.dataset.tab = key;
                button.className = `p-2 px-4 font-medium text-gray-700 hover:text-blue-600 transition duration-150 button-click-effect 
                                    ${isActive ? 'border-b-2 border-blue-600 text-blue-600' : 'hover:border-b-2 hover:border-blue-300'}`;

                button.onclick = () => {
                    if (currentTab === key) return;
                    currentTab = key;
                    renderProfileTutorialContent();
                    window.location.hash = `#profile-tutorial:${currentTab}`;
                };

                $navBar.appendChild(button);
            });

            // 渲染內容區
            $contentArea.style.opacity = '0';
            $contentArea.style.transform = 'translateX(-20px)';

            setTimeout(() => {
                let contentHTML = '';
                const tabTitle = navTabs[currentTab] ? navTabs[currentTab].title : '未知標籤';

                if (currentTab === 'account') {
                    // ** 帳號區塊 (內容保持不變) **
                    contentHTML = `
                        <h4 class="text-2xl font-semibold mb-4 text-blue-700">${tabTitle} </h4>
                        <p class="text-gray-600 mt-4">其他帳號相關資訊，例如電子郵件、會員等級等...</p>
                        <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner flex items-center justify-between">
                            <span class="text-xl font-medium text-gray-700 flex items-center">
                                修改您的個人暱稱:${currentNickname}
                            </span>
                            <button id="edit-nickname-btn" class="text-blue-500 hover:text-blue-700 button-click-effect ml-3 p-1 rounded-full bg-white shadow">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                    class="w-5 h-5">
                                    <path d="M17 3a2.85 2.85 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                </svg>
                            </button>
                        </div>
                    `;

                } else if (currentTab === 'reportIssue') {
                    // ** 回報問題區塊：新增容器並準備載入外部 HTML **
                    contentHTML = `
                        <h4 class="text-2xl font-semibold mb-4 text-blue-700">${tabTitle} 區塊</h4>
                        <p class="text-gray-600 mb-4">請在下方表單填寫您遇到的問題，我們會盡快處理。</p>
                        <div id="error-form-container" class="border border-gray-200 p-4 rounded-lg bg-gray-50">
                            <p class="text-center text-gray-500">載入表單中...</p>
                        </div>
                    `;

                } else {
                    // ** 其他區塊 (設定 / 產品聲明) **
                    contentHTML = `
                        <h4 class="text-2xl font-semibold mb-4 text-blue-700">${tabTitle} 區塊</h4>
                        <p class="text-gray-600">${navTabs[currentTab].content}</p>
                        <div class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded">
                            <p class="font-bold">內容提示:</p>
                            <p>這是 ${tabTitle} 的預留內容。請在此處添加具體的 UI/表單。</p>
                        </div>
                    `;
                }


                $contentArea.innerHTML = contentHTML;
                $contentArea.style.opacity = '1';
                $contentArea.style.transform = 'translateX(0)';


                // 如果當前是 'account' 頁面，重新綁定編輯暱稱按鈕
                if (currentTab === 'account') {
                    const $editNicknameBtn = document.getElementById('edit-nickname-btn');
                    if ($editNicknameBtn) {
                        $editNicknameBtn.addEventListener('click', handleNicknameEdit);
                    }
                }

                // *** 核心修正：異步載入 errorform.html ***
                else if (currentTab === 'reportIssue') {
                    const $formContainer = document.getElementById('error-form-container');
                    if ($formContainer) {
                        fetch('errorform.html')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
                                }
                                return response.text();
                            })
                            .then(html => {
                                // 將載入的 HTML 內容放入容器
                                $formContainer.innerHTML = html;
                            })
                            .catch(error => {
                                console.error("載入 errorform.html 失敗:", error);
                                $formContainer.innerHTML = `<p class="text-red-500 font-bold">載入表單失敗，請檢查 errorform.html 檔案是否存在於同一目錄或路徑是否正確。</p>`;
                            });
                    }
                }
                // *** 核心修正結束 ***
            }, 100); // 延遲 100ms 觸發滑動效果


        }

        /**
         * 處理 URL Hash 導航
         */
        function handleInitialNavigation() {
            const hash = window.location.hash.slice(1);

            if (hash === 'dashboard' || hash === '') {
                currentView = 'dashboard';
            } else if (hash === 'tutorial-page') {
                currentView = 'tutorial-page';
            } else if (hash.startsWith('profile-tutorial')) {
                const parts = hash.split(':');
                const view = parts[0];
                const tab = parts[1] || 'settings'; // 預設為設定

                // 檢查 tab 是否存在於 navTabs 中 (不包含 tutorial)
                if (['settings', 'account', 'productStatement', 'reportIssue'].includes(tab)) {
                    currentView = view;
                    currentTab = tab;
                } else {
                    currentView = 'dashboard'; // 如果 hash 無效，回到儀表板
                }
            } else {
                currentView = 'dashboard';
            }

            renderView();
        }

        /**
         * 處理暱稱編輯邏輯 (彈出視窗)
         */
        function handleNicknameEdit() {
            const newName = prompt("請輸入新的暱稱:", currentNickname);

            if (newName && newName.trim() !== '' && newName !== currentNickname) {
                window.setNickname(newName.trim()); // 呼叫全域 setNickname
            } else if (newName !== null) {
                showModal("暱稱未修改或輸入無效。");
            }
        }

        // 7. 事件監聽器

        // 點擊事件代理 (處理所有桌面菜單子項目的點擊)
        document.addEventListener('click', (e) => {
            const item = e.target.closest('.dropdown-item');
            if (item) {
                e.preventDefault(); // 阻止 a 標籤的預設導航
                const tab = item.dataset.tab;
                // 點擊後跳轉到子頁面 (targetView固定為 profile-tutorial)
                navigate('profile-tutorial', tab);
            }
        });

        // 漢堡菜單切換 (點擊按鈕開啟或關閉)
        $hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // 阻止事件冒泡，避免立即觸發 document 上的關閉邏輯
            $sidebar.classList.toggle('active');
        });

        // 點擊側邊欄外部區域時關閉側邊欄
        document.addEventListener('click', (e) => {
            const isClickInsideSidebar = $sidebar.contains(e.target);
            const isClickOnHamburger = $hamburgerBtn.contains(e.target) || e.target === $hamburgerBtn;

            if ($sidebar.classList.contains('active') && !isClickInsideSidebar && !isClickOnHamburger) {
                $sidebar.classList.remove('active');
            }
        });

        // 登出按鈕
        async function handleSignOut() {
            if (!auth) {
                showModal("登出失敗：應用程式初始化錯誤。");
                return;
            }

            try {
                isLoggingOut = true;

                // *** 修正：在登出前，明確停止 Firestore 監聽，消除暱稱錯誤 ***
                if (unsubscribeNicknameListener) {
                    unsubscribeNicknameListener();
                    unsubscribeNicknameListener = null;
                }

                await signOut(auth); // 執行登出

                // *** 核心修正：使用新的 showModal 實現自動跳轉，無確認按鈕 ***
                showModal(
                    "您已成功登出！即將跳轉至首頁。",
                    () => {
                        window.location.href = HOME_PAGE_URL;
                    },
                    false, // showConfirm = false (不顯示確認按鈕)
                    1500  // duration = 1500ms (1.5 秒後自動關閉並執行 callback)
                );

                // 移除原有的 setTimeout 跳轉邏輯，由 showModal 處理

            } catch (error) {
                console.error("登出失敗:", error);
                showModal(`登出失敗: ${error.message}`);
                isLoggingOut = false;
            }
        }
        $logoutBtn.addEventListener('click', handleSignOut);

        // 8. 程式啟動
        window.addEventListener('load', () => {
            generateSidebarMenu();
        });

        // 9. 側邊欄生成函數 (與桌面版保持一致)
        function generateSidebarMenu() {
            const menuData = [
                {
                    title: '帳號與設定', items: [
                        { name: '設定', tab: 'settings' },
                        { name: '帳號', tab: 'account' },
                        { name: '產品聲明', tab: 'productStatement' },
                        { name: '回報問題', tab: 'reportIssue' }
                    ]
                },
                { title: '我的數據', tab: 'data', target: 'dashboard' },
                { title: '使用教學', tab: 'tutorial', target: 'profile-tutorial' },
                {
                    title: '已登入', items: [
                        { name: '登出', tab: 'logout' }
                    ]
                }
            ];

            const nav = $sidebar.querySelector('nav');
            nav.innerHTML = ''; // 清空內容

            menuData.forEach(mainItem => {
                if (mainItem.items) {
                    // 有子項目的菜單 (Accordion Style)
                    const details = document.createElement('details');
                    details.className = 'w-full';

                    const summary = document.createElement('summary');
                    summary.className = 'p-3 text-lg font-medium text-gray-700 hover:text-gray-900 cursor-pointer rounded-lg bg-gray-50 hover:bg-gray-100 transition button-click-effect';
                    summary.textContent = mainItem.title;

                    const subMenu = document.createElement('div');
                    subMenu.className = 'pl-4 py-2 space-y-1';

                    mainItem.items.forEach(subItem => {
                        const link = document.createElement('a');

                        let onclickAction;
                        let href;

                        if (subItem.tab === 'logout') {
                            // 修正: 將 Maps 改為 navigate
                            onclickAction = `Maps('dashboard', 'logout')`;
                            href = '#';
                        } else {
                            // 修正: 將 Maps 改為 navigate
                            onclickAction = `Maps('profile-tutorial', '${subItem.tab}')`;
                            href = `#profile-tutorial:${subItem.tab}`;
                        }

                        link.setAttribute('onclick', onclickAction);
                        link.href = href;
                        link.className = 'block px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md button-click-effect';
                        link.textContent = subItem.name;
                        subMenu.appendChild(link);
                    });

                    details.appendChild(summary);
                    details.appendChild(subMenu);
                    nav.appendChild(details);
                } else {
                    // 無子項目的菜單 (我的數據 / 使用教學)
                    const button = document.createElement('button');
                    button.textContent = mainItem.title;
                    button.className = 'w-full text-left p-3 text-lg font-medium text-gray-700 hover:text-gray-900 cursor-pointer rounded-lg bg-gray-50 hover:bg-gray-100 transition button-click-effect';

                    // 獨立按鈕直接導航到其目標 view
                    // *** 最終修正: 將 Maps 替換為 navigate ***
                    button.setAttribute('onclick', `Maps('${mainItem.target}', '${mainItem.tab}')`);

                    nav.appendChild(button);
                }
            });
        }

        // 10. URL hash 變化時，重新導航
        window.addEventListener('hashchange', handleInitialNavigation);

        // 11. 處理瀏覽器快取和返回按鈕的認證檢查 (請確認這段代碼存在)
        window.addEventListener('pageshow', function (event) {
            // 如果頁面是從快取中讀取（例如按了「上一頁」）
            if (event.persisted) {
                console.log("偵測到頁面從快取中載入。執行強制認證檢查。");
                // 檢查 auth 物件是否已定義，且當前沒有用戶登入，且不是在登出過程中
                if (auth && !auth.currentUser && !isLoggingOut) {
                    // 強制顯示未登入提示並跳轉
                    showModal("您尚未登入或登入已過期。請重新登入。", () => {
                        window.location.href = LOGIN_PAGE_URL;
                    });

                    document.getElementById('main-content-area').style.display = 'none';
                    document.getElementById('loading-spinner').style.display = 'none';
                }
            }
        });

    </script>
</body>

</html>